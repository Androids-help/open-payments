<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>Recurring Payments · Open Payments</title><meta name="viewport" content="width=device-width"/><meta name="generator" content="Docusaurus"/><meta name="description" content="The following use case demonstrates a merchant being able to charge customers at a regular interval. A merchant creates"/><meta name="docsearch:language" content="en"/><meta property="og:title" content="Recurring Payments · Open Payments"/><meta property="og:type" content="website"/><meta property="og:url" content="https://openpayments.dev//"/><meta property="og:description" content="The following use case demonstrates a merchant being able to charge customers at a regular interval. A merchant creates"/><meta property="og:image" content="https://openpayments.dev/img/undraw_online.svg"/><meta name="twitter:card" content="summary"/><meta name="twitter:image" content="https://openpayments.dev/img/undraw_tweetstorm.svg"/><link rel="shortcut icon" href="/img/favicon.ico"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/8.4.4/mermaid.min.js"></script><script type="text/javascript" src="scripts/init.js"></script><script src="/js/scrollSpy.js"></script><link rel="stylesheet" href="/css/main.css"/><script src="/js/codetabs.js"></script></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/"><img class="logo" src="/img/favicon.ico" alt="Open Payments"/><h2 class="headerTitleWithLogo">Open Payments</h2></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class="siteNavGroupActive"><a href="/docs/overview" target="_self">Specification</a></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="docsNavContainer" id="docsNav"><nav class="toc"><div class="toggleNav"><section class="navWrapper wrapper"><div class="navBreadcrumb wrapper"><div class="navToggle" id="navToggler"><div class="hamburger-menu"><div class="line1"></div><div class="line2"></div><div class="line3"></div></div></div><h2><i>›</i><span>Use Cases</span></h2><div class="tocToggler" id="tocToggler"><i class="icon-toc"></i></div></div><div class="navGroups"><div class="navGroup"><h3 class="navGroupCategoryTitle">Overview</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/overview">Open Payments</a></li><li class="navListItem"><a class="navItem" href="/docs/oauth">OAuth 2.0 and Open ID Connect</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Specification</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/resources">Resources</a></li><li class="navListItem"><a class="navItem" href="/docs/protocol">Protocol</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Use Cases</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/checkout_push">Checkout (Push)</a></li><li class="navListItem navListItemActive"><a class="navItem" href="/docs/recurring">Recurring Payments</a></li><li class="navListItem"><a class="navItem" href="/docs/web-monetization">Web Monetization</a></li></ul></div></div></section></div><script>
            var coll = document.getElementsByClassName('collapsible');
            var checkActiveCategory = true;
            for (var i = 0; i < coll.length; i++) {
              var links = coll[i].nextElementSibling.getElementsByTagName('*');
              if (checkActiveCategory){
                for (var j = 0; j < links.length; j++) {
                  if (links[j].classList.contains('navListItemActive')){
                    coll[i].nextElementSibling.classList.toggle('hide');
                    coll[i].childNodes[1].classList.toggle('rotate');
                    checkActiveCategory = false;
                    break;
                  }
                }
              }

              coll[i].addEventListener('click', function() {
                var arrow = this.childNodes[1];
                arrow.classList.toggle('rotate');
                var content = this.nextElementSibling;
                content.classList.toggle('hide');
              });
            }

            document.addEventListener('DOMContentLoaded', function() {
              createToggler('#navToggler', '#docsNav', 'docsSliderActive');
              createToggler('#tocToggler', 'body', 'tocActive');

              var headings = document.querySelector('.toc-headings');
              headings && headings.addEventListener('click', function(event) {
                var el = event.target;
                while(el !== headings){
                  if (el.tagName === 'A') {
                    document.body.classList.remove('tocActive');
                    break;
                  } else{
                    el = el.parentNode;
                  }
                }
              }, false);

              function createToggler(togglerSelector, targetSelector, className) {
                var toggler = document.querySelector(togglerSelector);
                var target = document.querySelector(targetSelector);

                if (!toggler) {
                  return;
                }

                toggler.onclick = function(event) {
                  event.preventDefault();

                  target.classList.toggle(className);
                };
              }
            });
        </script></nav></div><div class="container mainContainer docsContainer"><div class="wrapper"><div class="post"><header class="postHeader"><h1 id="__docusaurus" class="postHeaderTitle">Recurring Payments</h1></header><article><div><span><p>The following use case demonstrates a merchant being able to charge customers at a regular interval. A merchant creates
and authorizes a mandate for its customer at the customers respective Issuer. The mandate is a form of delegated access
authorized by the customer which contains details about the interval,
frequency, amount and start and end dates. The merchant can then submit invoices against the mandate to instruct
the Issuer to perform payments.</p>
<div class="mermaid">sequenceDiagram
    participant Sender
    participant Issuer as Issuer<br/>(sending wallet)
    participant Acquirer as Acquirer<br/>(receiving wallet)
    participant Receiver

    Sender->>Receiver: Produce $PaymentPointer

    Receiver->>Issuer: Get Open Payments Metadata

    Receiver->>Issuer: POST /mandates
    activate Receiver
    activate Issuer
    Issuer->>Issuer: Create Mandate
    Issuer-->>Receiver: 201 Response
    deactivate Issuer
    deactivate Receiver

    Receiver->>Issuer: Authorise Mandate
    activate Receiver
    activate Issuer
    
        Issuer->>Sender: Mandate Consent
        activate Sender
        Sender-->>Issuer: Accept Mandate
        deactivate Sender

    Issuer-->>Receiver: Respond Auth Tokens
    deactivate Receiver
    deactivate Issuer



    loop Interval of Payment
    
    Receiver->>Acquirer: POST /invoices
    activate Receiver
    activate Acquirer
    Acquirer->>Acquirer: createInvoice(invoice)
    Acquirer-->>Receiver: 201 paid=false
    deactivate Acquirer
    deactivate Receiver

    Receiver->>Issuer: POST /mandates/{id}/spend (invoice, auth_token)
    activate Receiver
    activate Issuer

    Issuer->>Acquirer: GET invoice_url
    activate Acquirer
    Acquirer-->>Issuer: 200 destination_address, shared_secret
    deactivate Acquirer
    rect rgb(0, 255, 0)
        Issuer->>Acquirer: [ push payment ]
        activate Acquirer
    end
    Acquirer->>Acquirer: updateInvoiceBalance(amount)
    deactivate Acquirer

    Issuer-->>Receiver: Response
    deactivate Receiver
    deactivate Issuer

   
    Receiver->>Acquirer: GET /invoices/{id}
    activate Receiver
    activate Acquirer
    Acquirer->>Receiver: 200 invoice
    deactivate Receiver
    deactivate Acquirer
    end
</div><h1><a class="anchor" aria-hidden="true" id="flow"></a><a href="#flow" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Flow</h1>
<p>Based on the diagram above the flow is as follows:</p>
<ol>
<li>Customer would provide their Payment Pointer to the Merchant</li>
<li>Merchant uses the Payment Pointer to discover the Open Payments metadata</li>
<li>Merchant creates a mandate on the Issuer wallet</li>
<li>Merchant requests authorization for the mandate from the Issuer. Issuer goes through a consent flow</li>
<li>Merchant can now submit invoices against the mandate for payments it wants to execute.</li>
</ol>
<h2><a class="anchor" aria-hidden="true" id="1-providing-payment-pointer-to-merchant"></a><a href="#1-providing-payment-pointer-to-merchant" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>1. Providing Payment Pointer to Merchant</h2>
<p>Wallets following the Open Payments spec will issue Payment Pointers to their customers. When a Merchant wishes to initiate
an Open Payments interaction</p>
<h2><a class="anchor" aria-hidden="true" id="2-discover-open-payments-metadata"></a><a href="#2-discover-open-payments-metadata" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>2. Discover Open Payments metadata</h2>
<p>Using the Payment Pointer provided, the Merchant will perform a GET against the correct url.</p>
<pre><code class="hljs css language-http"><span class="hljs-keyword">GET</span> <span class="hljs-string">/.well-known/open-payments-server</span> HTTP/1.1
<span class="hljs-attribute">Host</span>: issuer.wallet
</code></pre>
<p>A successful <code>200</code> response will return the Open Payments metadata</p>
<pre><code class="hljs css language-http">HTTP/1.1 <span class="hljs-number">200</span> OK
<span class="hljs-attribute">Content-Type</span>: application/json

<span class="json">{
  <span class="hljs-attr">"issuer"</span>: <span class="hljs-string">"https://issuer.wallet"</span>,
  <span class="hljs-attr">"authorization_endpoint"</span>: <span class="hljs-string">"https://issuer.wallet/authorize"</span>,
  <span class="hljs-attr">"token_endpoint"</span>: <span class="hljs-string">"https://issuer.wallet/token"</span>,
  <span class="hljs-attr">"token_endpoint_auth_methods_supported"</span>: [<span class="hljs-string">"client_secret_basic"</span>,<span class="hljs-string">"private_key_jwt"</span>],
  <span class="hljs-attr">"token_endpoint_auth_signing_alg_values_supported"</span>: [<span class="hljs-string">"RS256"</span>, <span class="hljs-string">"ES256"</span>],
  <span class="hljs-attr">"userinfo_endpoint"</span>: <span class="hljs-string">"https://issuer.wallet/userinfo"</span>,
  <span class="hljs-attr">"jwks_uri"</span>: <span class="hljs-string">"https://issuer.wallet/jwks.json"</span>,
  <span class="hljs-attr">"registration_endpoint"</span>: <span class="hljs-string">"https://issuer.wallet/register"</span>,
  <span class="hljs-attr">"scopes_supported"</span>: [<span class="hljs-string">"openid"</span>,<span class="hljs-string">"profile"</span>,<span class="hljs-string">"email"</span>,<span class="hljs-string">"address"</span>,<span class="hljs-string">"phone"</span>,<span class="hljs-string">"offline_access"</span>],
  <span class="hljs-attr">"response_types_supported"</span>: [<span class="hljs-string">"code"</span>, <span class="hljs-string">"token"</span>],
  <span class="hljs-attr">"service_documentation"</span>: <span class="hljs-string">"https://issuer.wallet/service_documentation.html"</span>,
  <span class="hljs-attr">"ui_locales_supported"</span>: [<span class="hljs-string">"en-US"</span>, <span class="hljs-string">"en-GB"</span>, <span class="hljs-string">"en-CA"</span>, <span class="hljs-string">"fr-FR"</span>, <span class="hljs-string">"fr-CA"</span>],
  <span class="hljs-attr">"payment_invoices_endpoint"</span>: <span class="hljs-string">"https://issuer.wallet/invoices"</span>,
  <span class="hljs-attr">"payment_mandates_endpoint"</span>: <span class="hljs-string">"https://issuer.wallet/mandates"</span>,
  <span class="hljs-attr">"payment_sessions_endpoint"</span>: <span class="hljs-string">"https://issuer.wallet/sessions"</span>,
  <span class="hljs-attr">"payment_assets_supported"</span>: [
    {<span class="hljs-attr">"code"</span>: <span class="hljs-string">"USD"</span>, <span class="hljs-attr">"scale"</span>: <span class="hljs-number">2</span>},
    {<span class="hljs-attr">"code"</span>: <span class="hljs-string">"EUR"</span>, <span class="hljs-attr">"scale"</span>: <span class="hljs-number">2</span>}
  ]
}
</span></code></pre>
<p>The Merchant can now find <code>payment_mandates_endpoint</code> with which to create the necessary mandate</p>
<h2><a class="anchor" aria-hidden="true" id="3-create-mandate-on-the-issuer-wallet"></a><a href="#3-create-mandate-on-the-issuer-wallet" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>3. Create mandate on the Issuer wallet</h2>
<p>The Merchant creates a mandate on the customers Issuers wallet using the endpoint above</p>
<pre><code class="hljs css language-http"><span class="hljs-keyword">POST</span> <span class="hljs-string">/mandates</span> HTTP/1.1
<span class="hljs-attribute">Host</span>: issuer.wallet
<span class="hljs-attribute">Accept</span>: application/json
<span class="hljs-attribute">Content-Type</span>: application/json

<span class="json">{
  <span class="hljs-attr">"amount"</span>: <span class="hljs-number">200</span>,
  <span class="hljs-attr">"asset"</span> : {
    <span class="hljs-attr">"code"</span>: <span class="hljs-string">"USD"</span>,
    <span class="hljs-attr">"scale"</span>: <span class="hljs-number">2</span>
  },
  <span class="hljs-attr">"interval"</span>: <span class="hljs-string">"P1M"</span>,
  <span class="hljs-attr">"scope"</span>: <span class="hljs-string">"issuer.wallet/alice"</span>
}
</span></code></pre>
<pre><code class="hljs css language-http">HTTP/1.1 <span class="hljs-number">201</span> Created
<span class="hljs-attribute">Content-Type</span>: application/json

<span class="json">{
  <span class="hljs-attr">"name"</span>: <span class="hljs-string">"//issuer.wallet/mandates/2fad69d0-7997-4543-8346-69b418c479a6"</span>,
  <span class="hljs-attr">"amount"</span>: <span class="hljs-number">200</span>,
  <span class="hljs-attr">"asset"</span> : {
    <span class="hljs-attr">"code"</span>: <span class="hljs-string">"USD"</span>,
    <span class="hljs-attr">"scale"</span>: <span class="hljs-number">2</span>
  },
  <span class="hljs-attr">"interval"</span>: <span class="hljs-string">"P1M"</span>,
  <span class="hljs-attr">"start_at"</span>: <span class="hljs-string">"2020-01-22T00:00:00Z"</span>,
  <span class="hljs-attr">"scope"</span>: <span class="hljs-string">"issuer.wallet/alice"</span>,
  <span class="hljs-attr">"balance"</span>: <span class="hljs-number">200</span> 
}
</span></code></pre>
<h2><a class="anchor" aria-hidden="true" id="4-merchant-requests-authorization-for-mandate"></a><a href="#4-merchant-requests-authorization-for-mandate" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>4. Merchant requests authorization for mandate</h2>
<p>The merchant submits the mandate to the AS of the Issuer in order get authorization from the user.</p>
<p><strong>TODO</strong> Flesh out the authorization flow and then show an example</p>
<p>This results in the Merchant getting an access_token with which to use against the mandate.</p>
<h2><a class="anchor" aria-hidden="true" id="5-merchant-spends-against-mandate"></a><a href="#5-merchant-spends-against-mandate" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>5. Merchant spends against mandate</h2>
<p>The merchant can now submit spends against the mandate for goods/services rendered. The merchant can do this as often
as necessary, as long as the overall spends don't exceed the limit of the current mandate interval.</p>
<h3><a class="anchor" aria-hidden="true" id="create-invoice"></a><a href="#create-invoice" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Create invoice</h3>
<p>When the Merchant wants to PUSH money to itself from the mandate, it will first create an invoice on its Acquirer.</p>
<pre><code class="hljs css language-http"><span class="hljs-keyword">POST</span> <span class="hljs-string">/invoices</span> HTTP/1.1
<span class="hljs-attribute">Host</span>: acquirer.wallet
<span class="hljs-attribute">Authorization</span>: Bearer eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJodHRwOi...
<span class="hljs-attribute">Accept</span>: application/json
<span class="hljs-attribute">Content-Type</span>: application/json

<span class="json">{
  <span class="hljs-attr">"subject"</span>: <span class="hljs-string">"$acquirer.wallet/merchant"</span>,
  <span class="hljs-attr">"asset"</span>: {
    <span class="hljs-attr">"code"</span>: <span class="hljs-string">"USD"</span>,
    <span class="hljs-attr">"scale"</span>: <span class="hljs-number">2</span>
  },
  <span class="hljs-attr">"amount"</span>: <span class="hljs-number">100</span>
}
</span></code></pre>
<pre><code class="hljs css language-http">HTTP/1.1 <span class="hljs-number">201</span> Created
<span class="hljs-attribute">Content-Type</span>: application/json
<span class="hljs-attribute">Location</span>: https://acquirer.wallet/sessions/2d24bd87-1afc-465e-a4ec-07cb4f70f7b0

<span class="json">{
  <span class="hljs-attr">"name"</span>: <span class="hljs-string">"//acquirer.wallet/invoices/2d24bd87-1afc-465e-a4ec-07cb4f70f7b0"</span>,
  <span class="hljs-attr">"subject"</span>: <span class="hljs-string">"$acquirer.wallet/merchant"</span>,
  <span class="hljs-attr">"amount"</span>: <span class="hljs-number">200</span>,
  <span class="hljs-attr">"asset"</span>: {
    <span class="hljs-attr">"code"</span>: <span class="hljs-string">"USD"</span>,
    <span class="hljs-attr">"scale"</span>: <span class="hljs-number">2</span>
  },
  <span class="hljs-attr">"received"</span>: <span class="hljs-number">0</span>
}
</span></code></pre>
<h3><a class="anchor" aria-hidden="true" id="submit-invoice-to-mandate"></a><a href="#submit-invoice-to-mandate" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Submit invoice to mandate</h3>
<p>Using the created invoice it will submit a SPEND against the mandate using the invoice name</p>
<pre><code class="hljs css language-http"><span class="hljs-keyword">POST</span> <span class="hljs-string">/mandates/2fad69d0-7997-4543-8346-69b418c479a6/spend</span> HTTP/1.1
<span class="hljs-attribute">Host</span>: issuer.wallet
<span class="hljs-attribute">Authorization</span>: Bearer random_auth_token
<span class="hljs-attribute">Accept</span>: application/json
<span class="hljs-attribute">Content-Type</span>: application/json

<span class="json">{
  <span class="hljs-attr">"invoice"</span>: <span class="hljs-string">"//acquirer.wallet/invoices/2d24bd87-1afc-465e-a4ec-07cb4f70f7b0"</span>
}

</span></code></pre>
<pre><code class="hljs css language-http">HTTP/1.1 <span class="hljs-number">201</span> Created
</code></pre>
<p>This will instruct the Issuer to perform a payment of the invoice within the scope of the given mandate.</p>
<h3><a class="anchor" aria-hidden="true" id="payment"></a><a href="#payment" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Payment</h3>
<p>In order for the Issuer to complete the payment it would need to get payment details from the invoice. By doing a GET against
the invoice it can get the required <code>destination_address</code> and <code>shared_secret</code></p>
<pre><code class="hljs css language-http"><span class="hljs-keyword">GET</span> <span class="hljs-string">/invoices/2d24bd87-1afc-465e-a4ec-07cb4f70f7b0</span> HTTP/1.1
<span class="hljs-attribute">Host</span>: acquirer.wallet
<span class="hljs-attribute">Accept</span>: application/json
<span class="hljs-attribute">Content-Type</span>: application/json

<span class="json">{
  <span class="hljs-attr">"subject"</span>: <span class="hljs-string">"$acquirer.wallet/merchant"</span>,
  <span class="hljs-attr">"asset"</span>: {
    <span class="hljs-attr">"code"</span>: <span class="hljs-string">"USD"</span>,
    <span class="hljs-attr">"scale"</span>: <span class="hljs-number">2</span>
  },
  <span class="hljs-attr">"amount"</span>: <span class="hljs-number">100</span>,
  <span class="hljs-attr">"received"</span>: <span class="hljs-number">0</span>,
  <span class="hljs-attr">"destination_address"</span>: <span class="hljs-string">"g.aquirer.42e0f0c9284ad401b7c941bc6173f4e"</span>,
  <span class="hljs-attr">"shared_secret"</span>: <span class="hljs-string">"AvLaEGc+ojGHVezQF9DC4/7F5YIvrNPx/VM+4hJkCbs="</span>,
}
</span></code></pre>
<p>The Issuer uses the payment details to perform the payment over Interledger using STREAM.</p>
<p>As payments are fulfilled, the <code>received</code> amount on the invoice would increase to reflect the payments.</p>
<h2><a class="anchor" aria-hidden="true" id="4-check-payment"></a><a href="#4-check-payment" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>4. Check payment</h2>
<p>The merchant would validate the payment of the invoice with the Acquirer. This could be achieved through polling against the invoice
or the Acquirer could provide convenience webhooks for the merchant to get notified of successful payments. This is left up to Wallets to
decide to implement.</p>
</span></div></article></div><div class="docs-prevnext"><a class="docs-prev button" href="/docs/checkout_push"><span class="arrow-prev">← </span><span>Checkout (Push)</span></a><a class="docs-next button" href="/docs/web-monetization"><span>Web Monetization</span><span class="arrow-next"> →</span></a></div></div></div><nav class="onPageNav"><ul class="toc-headings"><li><a href="#1-providing-payment-pointer-to-merchant">1. Providing Payment Pointer to Merchant</a></li><li><a href="#2-discover-open-payments-metadata">2. Discover Open Payments metadata</a></li><li><a href="#3-create-mandate-on-the-issuer-wallet">3. Create mandate on the Issuer wallet</a></li><li><a href="#4-merchant-requests-authorization-for-mandate">4. Merchant requests authorization for mandate</a></li><li><a href="#5-merchant-spends-against-mandate">5. Merchant spends against mandate</a><ul class="toc-headings"><li><a href="#create-invoice">Create invoice</a></li><li><a href="#submit-invoice-to-mandate">Submit invoice to mandate</a></li><li><a href="#payment">Payment</a></li></ul></li><li><a href="#4-check-payment">4. Check payment</a></li></ul></nav></div><footer class="nav-footer" id="footer"><section class="sitemap"><a href="/" class="nav-home"><img src="/img/favicon.ico" alt="Open Payments" width="66" height="58"/></a><div><h5>Protocol</h5><a href="/docs/en/overview">Overview</a><a href="/en/rafiki">Demo</a></div><div><h5>Code</h5><a href="https://github.com/adrianhopebailie/open-payments">GitHub</a><a class="github-button" data-icon="octicon-star" data-count-href="/adrianhopebailie/open-payments/stargazers" data-show-count="true" data-count-aria-label="# stargazers on GitHub" aria-label="Star this project on GitHub">Star</a></div></section><section class="copyright">Copyright © 2020 Coil Technologies</section></footer></div></body></html>